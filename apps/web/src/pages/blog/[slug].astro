---
import { getCollection, type CollectionEntry } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { toBlogRouteId } from '../../lib/blog/blog-entry-id';
import { createFileUpdatedAtLoader, getDefaultBlogUpdatedAtFilePath } from '../../lib/updated-at';
import styles from './[slug].module.css';

type Props = {
  entry: CollectionEntry<'blog'>;
};

export async function getStaticPaths() {
  const entries = await getCollection('blog', ({ data }) => !data.draft);
  return entries.map((entry) => ({
    params: { slug: toBlogRouteId(entry.id) },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();

const pageTitle = `${entry.data.title} | Blog | seri-kun`;
const description = entry.data.description;
const canonicalUrl = Astro.site ? new URL(Astro.url.pathname, Astro.site) : Astro.url;
const updatedAtLoader = createFileUpdatedAtLoader(getDefaultBlogUpdatedAtFilePath());
const updatedAtIso = await updatedAtLoader.getBlogUpdatedAtIso(entry.id);
const updatedAtDate = updatedAtIso ? updatedAtIso.slice(0, 10) : null;
const shouldShowUpdatedAt = updatedAtDate !== null && updatedAtDate !== entry.data.publishedAt;
---

<BaseLayout title={pageTitle} description={description}>
  <Fragment slot="head">
    <meta property="og:title" content={entry.data.title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="article" />
    <meta property="og:url" content={canonicalUrl.toString()} />
  </Fragment>

  <article class={`prose ${styles.article}`}>
    <header class={styles.header}>
      <h1 class={styles.title}>{entry.data.title}</h1>
      <div class={styles.meta}>
        <div class={styles.metaItem}>
          <span class={styles.metaLabel}>公開</span>
          <time datetime={entry.data.publishedAt} class={styles.date}>
            {entry.data.publishedAt}
          </time>
        </div>
        {shouldShowUpdatedAt ? (
          <div class={styles.metaItem}>
            <span class={styles.metaLabel}>更新</span>
            <time datetime={updatedAtIso!} class={styles.date}>
              {updatedAtDate}
            </time>
          </div>
        ) : null}
      </div>
      {entry.data.tags.length ? (
        <div class={styles.tags} aria-label="Tags">
          {entry.data.tags.map((tag) => (
            <a class={styles.tag} href={`/blog?tag=${encodeURIComponent(tag)}`}>
              #{tag}
            </a>
          ))}
        </div>
      ) : null}
    </header>

    <div class={styles.content}>
      <Content />
    </div>
  </article>
</BaseLayout>
