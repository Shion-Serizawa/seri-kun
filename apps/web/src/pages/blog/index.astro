---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import {
  groupBlogPostsByMonth,
  listBlogTags,
  sortBlogListNewestFirst,
  type BlogListItem,
} from '../../lib/blog/blog-list';
import { toBlogRouteId } from '../../lib/blog/blog-entry-id';
import styles from './index.module.css';
import blogFilterScriptUrl from '../../lib/blog/blog-filter.client.ts?url';

const entries = await getCollection('blog', ({ data }) => !data.draft);

const posts: BlogListItem[] = entries.map((entry) => ({
  id: toBlogRouteId(entry.id),
  title: entry.data.title,
  publishedAt: entry.data.publishedAt,
  tags: entry.data.tags,
  description: entry.data.description,
}));

const sorted = sortBlogListNewestFirst(posts);
const groups = groupBlogPostsByMonth(sorted);
const tags = listBlogTags(sorted);
---

<BaseLayout title="Blog | seri-kun" description="ブログ一覧">
  <h1>Blog</h1>
  <p class={styles.intro}>メモ、設計、学び。</p>

  <section class={styles.controls} aria-label="Blog filters">
    <div class={styles.tags} role="list" aria-label="Tags">
      <a class={styles.tagLink} href="/blog" data-tag-link data-tag="" role="listitem">
        All
      </a>
      {tags.map((tag) => (
        <a
          class={styles.tagLink}
          href={`/blog?tag=${encodeURIComponent(tag)}`}
          data-tag-link
          data-tag={tag}
          role="listitem"
        >
          #{tag}
        </a>
      ))}
    </div>
    <div class={styles.status} id="blog-status" aria-live="polite"></div>
  </section>

  <p class={styles.empty} id="blog-empty" hidden>該当する記事がありません。</p>

  <div class={styles.groups} id="blog-groups">
    {groups.map((group) => (
      <section class={styles.month} data-month-group data-month={group.month}>
        <h2 class={styles.monthTitle}>{group.month}</h2>
        <ul class={styles.list} aria-label={`Posts in ${group.month}`}>
          {group.posts.map((post) => (
            <li
              class={styles.item}
              data-post
              data-tags={JSON.stringify(post.tags)}
              data-published-at={post.publishedAt}
            >
              <a class={styles.card} href={`/blog/${post.id}`}>
                <div class={styles.cardHead}>
                  <div class={styles.cardTitle}>{post.title}</div>
                  <time class={styles.cardDate} datetime={post.publishedAt}>
                    {post.publishedAt}
                  </time>
                </div>
                <p class={styles.cardDesc}>{post.description}</p>
                {post.tags.length ? (
                  <div class={styles.cardTags} aria-label="Tags">
                    {post.tags.map((tag) => (
                      <span class={styles.tagChip}>#{tag}</span>
                    ))}
                  </div>
                ) : null}
              </a>
            </li>
          ))}
        </ul>
      </section>
    ))}
  </div>

  <script is:inline type="module" src={blogFilterScriptUrl}></script>
</BaseLayout>
